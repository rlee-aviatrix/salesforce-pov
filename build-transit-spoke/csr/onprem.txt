ios-config-1="hostname ${onprem_csr_hostname}"
ios-config-1="username ${onprem_csr_username} privilege 15 password 0 ${onprem_csr_password}"

%{ for transit in transits ~}
ios-config-${transit.index_number}2="crypto keyring ${onprem_csr_public_ip}-${transit.ip}"
ios-config-${transit.index_number}2="pre-shared-key address ${transit.ip} key ${pre_shared_key}"
ios-config-${transit.index_number}2="exit"
ios-config-${transit.index_number}2="crypto isakmp policy ${transit.index_number}"
ios-config-${transit.index_number}2="encryption aes 256"
ios-config-${transit.index_number}2="authentication pre-share"
ios-config-${transit.index_number}2="hash sha256"
ios-config-${transit.index_number}2="group 14"
ios-config-${transit.index_number}2="lifetime 28800"
ios-config-${transit.index_number}2="exit"
ios-config-${transit.index_number}2="crypto isakmp keepalive 10 3 periodic"
ios-config-${transit.index_number}2="crypto isakmp profile ${onprem_csr_public_ip}-${transit.ip}"
ios-config-${transit.index_number}2="keyring ${onprem_csr_public_ip}-${transit.ip}"
ios-config-${transit.index_number}2="self-identity address"
ios-config-${transit.index_number}2="match identity address ${transit.ip} 255.255.255.255"
ios-config-${transit.index_number}2="exit"

ios-config-${transit.index_number}3="crypto ipsec transform-set ${onprem_csr_public_ip}-${transit.ip} esp-aes 256 esp-sha256-hmac"
ios-config-${transit.index_number}3="mode tunnel"
ios-config-${transit.index_number}3="exit"
ios-config-${transit.index_number}3="crypto ipsec df-bit clear"
ios-config-${transit.index_number}3="crypto ipsec profile ${onprem_csr_public_ip}-${transit.ip}"
ios-config-${transit.index_number}3="set security-association lifetime seconds 3600"
ios-config-${transit.index_number}3="set transform-set ${onprem_csr_public_ip}-${transit.ip}"
ios-config-${transit.index_number}3="set pfs group14"
ios-config-${transit.index_number}3="set isakmp-profile ${onprem_csr_public_ip}-${transit.ip}"
ios-config-${transit.index_number}3="set security-association lifetime kilobytes disable"
ios-config-${transit.index_number}3="set security-association lifetime seconds 3600"
ios-config-${transit.index_number}3="exit"

ios-config-${transit.index_number}4="interface Tunnel ${transit.index_number}1"
ios-config-${transit.index_number}4="ip address ${transit.onprem_tunnel_ip_1} 255.255.255.252"
ios-config-${transit.index_number}4="ip mtu 1436"
ios-config-${transit.index_number}4="ip tcp adjust-mss 1387"
ios-config-${transit.index_number}4="tunnel source GigabitEthernet1"
ios-config-${transit.index_number}4="tunnel mode ipsec ipv4"
ios-config-${transit.index_number}4="tunnel destination ${transit.ip}"
ios-config-${transit.index_number}4="tunnel protection ipsec profile ${onprem_csr_public_ip}-${transit.ip}"
ios-config-${transit.index_number}4="ip virtual-reassembly"
ios-config-${transit.index_number}4="exit"

ios-config-${transit.index_number}5="crypto keyring ${onprem_csr_public_ip}-${transit.ha_ip}"
ios-config-${transit.index_number}5="pre-shared-key address ${transit.ha_ip} key ${pre_shared_key}"
ios-config-${transit.index_number}5="exit"
ios-config-${transit.index_number}5="crypto isakmp profile ${onprem_csr_public_ip}-${transit.ha_ip}"
ios-config-${transit.index_number}5="keyring ${onprem_csr_public_ip}-${transit.ha_ip}"
ios-config-${transit.index_number}5="self-identity address"
ios-config-${transit.index_number}5="match identity address ${transit.ha_ip} 255.255.255.255"
ios-config-${transit.index_number}5="exit"

ios-config-${transit.index_number}6="crypto ipsec transform-set ${onprem_csr_public_ip}-${transit.ha_ip} esp-aes 256 esp-sha256-hmac"
ios-config-${transit.index_number}6="mode tunnel"
ios-config-${transit.index_number}6="exit"
ios-config-${transit.index_number}6="crypto ipsec profile ${onprem_csr_public_ip}-${transit.ha_ip}"
ios-config-${transit.index_number}6="set security-association lifetime seconds 3600"
ios-config-${transit.index_number}6="set transform-set ${onprem_csr_public_ip}-${transit.ha_ip}"
ios-config-${transit.index_number}6="set pfs group14"
ios-config-${transit.index_number}6="set isakmp-profile ${onprem_csr_public_ip}-${transit.ha_ip}"
ios-config-${transit.index_number}6="set security-association lifetime kilobytes disable"
ios-config-${transit.index_number}6="set security-association lifetime seconds 3600"
ios-config-${transit.index_number}6="exit"

ios-config-${transit.index_number}7="interface Tunnel ${transit.index_number}2"
ios-config-${transit.index_number}7="ip address ${transit.onprem_tunnel_ip_2} 255.255.255.252"
ios-config-${transit.index_number}7="ip mtu 1436"
ios-config-${transit.index_number}7="ip tcp adjust-mss 1387"
ios-config-${transit.index_number}7="tunnel source GigabitEthernet1"
ios-config-${transit.index_number}7="tunnel mode ipsec ipv4"
ios-config-${transit.index_number}7="tunnel destination ${transit.ha_ip}"
ios-config-${transit.index_number}7="tunnel protection ipsec profile ${onprem_csr_public_ip}-${transit.ha_ip}"
ios-config-${transit.index_number}7="ip virtual-reassembly"
ios-config-${transit.index_number}7="exit"

ios-config-${transit.index_number}8="router bgp 64778"
ios-config-${transit.index_number}8="bgp log-neighbor-changes"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_1} remote-as ${transit.aviatrix_bgp_asn}"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_1} timers 60 180"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_2} remote-as ${transit.aviatrix_bgp_asn}"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_2} timers 60 180"
ios-config-${transit.index_number}8="address-family ipv4"
ios-config-${transit.index_number}8="redistribute connected"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_1} activate"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_1} soft-reconfiguration inbound"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_2} activate"
ios-config-${transit.index_number}8="neighbor ${transit.aviatrix_tunnel_ip_2} soft-reconfiguration inbound"
ios-config-${transit.index_number}8="maximum-paths 4"
ios-config-${transit.index_number}8="exit-address-family"

%{ endfor ~}
